<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <title>טיימר משימות</title>
  <style>
    body { font-family: Arial, sans-serif; direction: rtl; background:#fafafa; }
    h1 { text-align:center; }
    table { width: 100%; border-collapse: collapse; margin-top:10px; background:white; }
    th, td { border: 1px solid #999; padding: 6px; text-align: center; }
    input[type="number"] { width: 60px; }
    input[type="text"] { width: 160px; }
    .muted { color: #777; font-size: 12px; }
    .badge { display:inline-block; padding:2px 6px; border-radius:6px; font-size:12px;}
    .running { background:#d9ffd9; }
    .paused  { background:#fff0b3; }
    .pending { background:#f2f2f2; }
    .done    { background:#e6e6e6; text-decoration: line-through; color:#666; }
    .row-actions { display:flex; gap:4px; flex-wrap:wrap; justify-content:center; }
    .toolbar { text-align:center; margin-bottom:12px }
  </style>
</head>
<body>

<h1>טיימר משימות</h1>

<div class="toolbar">
  <span id="now" class="muted"></span><br/>
  <strong>שעת סיום כוללת:</strong> <span id="overallEnd">-</span>
</div>

<div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center;margin-bottom:10px">
  <label>שם משימה חדשה
    <input id="newName" type="text" placeholder="שם משימה">
  </label>
  <label>שעות <input id="newH" type="number" min="0" value="0"></label>
  <label>דקות <input id="newM" type="number" min="0" value="0"></label>
  <label>שניות <input id="newS" type="number" min="0" value="0"></label>
  <button id="btnAdd">הוסף</button>
</div>

<table>
  <thead>
  <tr>
    <th>שם</th>
    <th>משך</th>
    <th>נותר</th>
    <th>שעת סיום</th>
    <th>סטטוס</th>
    <th>עריכה</th>
    <th>העברה</th>
    <th>פעולות</th>
  </tr>
  </thead>
  <tbody id="tbody"></tbody>
</table>

<script>
const $ = (sel) => document.querySelector(sel);
let editing = false;
let editTimeout = null;
let refreshTimer = null;

async function api(url, method="GET", body=null) {
  const opt = { method, headers: { "Content-Type": "application/json" } };
  if (body) opt.body = JSON.stringify(body);
  const res = await fetch(url, opt);
  if (!res.ok) {
    const msg = (await res.json()).error || res.statusText;
    throw new Error(msg);
  }
  return res.json();
}

async function render() {
  if (editing) return; // אל תעדכן בזמן עריכה
  const data = await api("/state");
  $("#overallEnd").textContent = data.overall_end_time;
  $("#now").textContent = data.now;
  const tb = $("#tbody");
  tb.innerHTML = "";
  data.tasks.forEach(t => {
    const tr = document.createElement("tr");
    tr.id = `row-${t.id}`;
    tr.className = t.status;
    const canEdit = (t.status !== "running");
    tr.innerHTML = `
      <td><input class="edit-name" type="text" value="${t.name}" ${canEdit?"":"disabled"}></td>
      <td>${t.duration}</td>
      <td>${t.remaining_hhmmss}</td>
      <td>${t.end_time_str}</td>
      <td>${t.status}</td>
      <td>
        <input class="edit-h" type="number" min="0" value="${Math.floor(t.duration/3600)}" ${canEdit?"":"disabled"}>
        <input class="edit-m" type="number" min="0" value="${Math.floor((t.duration%3600)/60)}" ${canEdit?"":"disabled"}>
        <input class="edit-s" type="number" min="0" value="${t.duration%60}" ${canEdit?"":"disabled"}>
      </td>
      <td>
        <input class="move-pos" type="number" min="1" value="${t.position+1}" style="width:50px">
        <button onclick="moveTask(${t.id})">העבר</button>
      </td>
      <td>
        <button onclick="startTask(${t.id})">התחל</button>
        <button onclick="pauseTask(${t.id})">השהה</button>
        <button onclick="resetTask(${t.id})">איפוס</button>
        <button onclick="deleteTask(${t.id})">מחק</button>
      </td>
    `;
    tb.appendChild(tr);
  });

  // מאזינים לעריכה
  document.querySelectorAll(".edit-name, .edit-h, .edit-m, .edit-s").forEach(inp=>{
    inp.addEventListener("focus",()=>{
      editing=true;
      clearInterval(refreshTimer);
    });
    inp.addEventListener("blur",()=>{
      editing=false;
      startAutoRefresh();
    });
    inp.addEventListener("input",()=>{
      clearTimeout(editTimeout);
      const id = parseInt(inp.closest("tr").id.split("-")[1]);
      editTimeout=setTimeout(()=>saveEdit(id),1000);
    });
  });
}

async function saveEdit(id){
  const row=document.getElementById(`row-${id}`);
  if(!row)return;
  const nm=row.querySelector(".edit-name").value;
  const h=parseInt(row.querySelector(".edit-h").value||"0");
  const m=parseInt(row.querySelector(".edit-m").value||"0");
  const s=parseInt(row.querySelector(".edit-s").value||"0");
  await api(`/update/${id}`,"POST",{name:nm,hours:h,minutes:m,seconds:s});
  render();
}

async function moveTask(id){
  const row=document.getElementById(`row-${id}`);
  const newPos=parseInt(row.querySelector(".move-pos").value||"1");
  await api("/reorder_single","POST",{task_id:id,new_position:newPos});
  render();
}

async function startTask(id){await api(`/start/${id}`,"POST");render();}
async function pauseTask(id){await api(`/pause/${id}`,"POST");render();}
async function resetTask(id){await api(`/reset/${id}`,"POST");render();}
async function deleteTask(id){await api(`/delete/${id}`,"POST");render();}
async function addTask(){
  const name=$("#newName").value||"משימה";
  const h=parseInt($("#newH").value||"0");
  const m=parseInt($("#newM").value||"0");
  const s=parseInt($("#newS").value||"0");
  await api("/add","POST",{name,hours:h,minutes:m,seconds:s});
  $("#newName").value="";$("#newH").value=0;$("#newM").value=0;$("#newS").value=0;
  render();
}

function startAutoRefresh(){
  clearInterval(refreshTimer);
  refreshTimer=setInterval(()=>{if(!editing)render();},1000);
}

startAutoRefresh();
render();
$("#btnAdd").addEventListener("click",addTask);
</script>
</body>
</html>
