<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <title>×˜×™×™××¨ ××©×™××•×ª â±ï¸</title>
    <style>
        body { font-family: Arial; background:#fafafa; padding:15px; }
        table { width:100%; border-collapse: collapse; margin-top:20px; }
        th, td { border:1px solid #ccc; padding:6px; text-align:center; }
        th { background:#eee; }
        .yellow { background:#fff7c0; }
        .gray { background:#f1f1f1; }
        .small-sim { font-size:12px; color:#666; }
    </style>
</head>

<body>

<h2>â±ï¸ ×˜×™×™××¨ ××©×™××•×ª</h2>

<div>
    <b>×©×¢×ª ×¡×™×•× ×›×•×œ×œ×ª:</b> <span id="overallEnd">-</span>
    &nbsp;&nbsp;&nbsp;
    <b>×–××Ÿ ×¢×‘×•×“×” ×›×•×œ×œ:</b> <span id="workTotal">00:00:00</span>
    &nbsp;&nbsp;&nbsp;
    <button onclick="toggleSim()">×”×¡×ª×¨ ×¡×™××•×œ×¦×™×”</button>
</div>

<br>

<table>
    <thead>
    <tr>
        <th>×©×¢×•×ª</th>
        <th>×“×§×•×ª</th>
        <th>×©× ×™×•×ª</th>
        <th>××™×§×•×</th>
        <th>â• ×”×•×¡×£</th>
        <th>ğŸ“¤ ×™×™×¦×</th>
        <th>ğŸ“¥ ×™×™×‘×</th>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td><input id="newH" style="width:50px"></td>
        <td><input id="newM" style="width:50px"></td>
        <td><input id="newS" style="width:50px"></td>
        <td><input id="newPos" style="width:50px"></td>
        <td><button onclick="addTask()">×”×•×¡×£</button></td>
        <td><button onclick="exportTasks()">×™×™×¦×</button></td>
        <td><input type="file" id="importFile" onchange="importTasks()" /></td>
    </tr>
    </tbody>
</table>

<br>

<table id="tasksTable">
    <thead>
    <tr>
        <th>×¢×‘×•×“×”</th>
        <th>×©×</th>
        <th>× ×•×ª×¨</th>
        <th>×©×¢×ª ×”×ª×—×œ×”</th>
        <th>×©×¢×ª ×¡×™×•×</th>
        <th>×¡×˜×˜×•×¡</th>
        <th>×¢×¨×™×›×”</th>
        <th>×”××¨×›×”</th>
        <th>×”×¢×‘×¨×”</th>
        <th>×¤×¢×•×œ×•×ª</th>
    </tr>
    </thead>
    <tbody id="tasksBody"></tbody>
</table>

<script>

let showSim = true;
function toggleSim() {
    showSim = !showSim;
    loadState();
}

function hhmmss(sec) {
    sec = Math.max(0, parseInt(sec || 0));
    let h = Math.floor(sec / 3600);
    let m = Math.floor((sec % 3600) / 60);
    let s = sec % 60;
    return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

async function loadState() {
    let r = await fetch("/state");
    let j = await r.json();

    document.getElementById("workTotal").textContent = j.work_total_hhmmss;
    document.getElementById("overallEnd").textContent = j.overall_end || "-";

    let body = document.getElementById("tasksBody");
    body.innerHTML = "";

    j.tasks.forEach(t => {

        //  ××—×©×•×‘ ×¡×™××•×œ×¦×™×”:
        let sim_remaining = t.remaining_sim ?? t.remaining;
        let sim_start = t.start_time_sim ?? t.start_time_str;
        let sim_end = t.end_time_sim ?? t.end_time_str;

        let tr = document.createElement("tr");

        tr.innerHTML = `
            <td><input type="checkbox" onchange="workFlag(${t.id}, this.checked)" ${t.is_work?"checked":""}></td>

            <td>${t.name}</td>

            <td>
                ${hhmmss(t.remaining)}<br>
                <span class="small-sim">${showSim ? hhmmss(sim_remaining) : ""}</span>
            </td>

            <td>
                ${t.start_time_str || "-"}<br>
                <span class="small-sim">${showSim ? (sim_start||"-") : ""}</span>
            </td>

            <td>
                ${t.end_time_str || "-"}<br>
                <span class="small-sim">${showSim ? (sim_end||"-") : ""}</span>
            </td>

            <td>${t.status}</td>

            <td>
                <button onclick="editTask(${t.id})">×¢×¨×™×›×”</button>
            </td>

            <td>
                <button onclick="extendTask(${t.id})">×”××¨×›×”</button>
            </td>

            <td>
                <button onclick="moveTask(${t.id})">×”×¢×‘×¨</button>
            </td>

            <td>
                <button onclick="startTask(${t.id})">×”×ª×—×œ</button>
                <button onclick="pauseTask(${t.id})">×”×©×”×”</button>
                <button onclick="doneTask(${t.id})">×¡×™×•×</button>
                <button onclick="deleteTask(${t.id})">ğŸ—‘</button>
            </td>
        `;

        body.appendChild(tr);
    });
}

async function startTask(id){ await fetch(`/start/${id}`,{method:"POST"}); loadState(); }
async function pauseTask(id){ await fetch(`/pause/${id}`,{method:"POST"}); loadState(); }
async function doneTask(id){ await fetch(`/done/${id}`,{method:"POST"}); loadState(); }
async function deleteTask(id){ await fetch(`/delete/${id}`,{method:"POST"}); loadState(); }

async function workFlag(id, val) {
    await fetch(`/workflag/${id}`,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ is_work:val })
    });
    loadState();
}

async function addTask(){
    let h = +document.getElementById("newH").value || 0;
    let m = +document.getElementById("newM").value || 0;
    let s = +document.getElementById("newS").value || 0;
    let pos = +document.getElementById("newPos").value || 1;

    await fetch("/add",{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({hours:h,minutes:m,seconds:s,position:pos})
    });
    loadState();
}

async function extendTask(id){
    let x = prompt("×”×•×¡×£ ×–××Ÿ (×©× ×™×•×ª):");
    x = parseInt(x||0);
    if(x>0){
        await fetch(`/extend/${id}`,{
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({seconds:x})
        });
        loadState();
    }
}

async function moveTask(id){
    let np = prompt("××™×§×•× ×—×“×©:");
    np = parseInt(np||0);
    if(np>=1){
        await fetch("/reorder_single",{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify({task_id:id,new_position:np})
        });
        loadState();
    }
}

async function editTask(id){
    let name = prompt("×©× ×—×“×©:");
    if(!name) return;
    let hh = prompt("×©×¢×•×ª:");
    let mm = prompt("×“×§×•×ª:");
    let ss = prompt("×©× ×™×•×ª:");

    await fetch(`/update/${id}`,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
            name:name,
            hours:parseInt(hh||0),
            minutes:parseInt(mm||0),
            seconds:parseInt(ss||0)
        })
    });
    loadState();
}

async function exportTasks(){
    window.location="/export";
}

async function importTasks(){
    let f = document.getElementById("importFile").files[0];
    if(!f) return;

    let txt = await f.text();
    await fetch("/import",{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: txt
    });

    loadState();
}

setInterval(loadState, 1000);
loadState();

</script>

</body>
</html>