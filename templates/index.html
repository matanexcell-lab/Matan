<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8">
<title>מנהל משימות - גרירה + כל הפיצ’רים</title>
<style>
body { font-family: Arial, sans-serif; direction: rtl; padding: 10px; }
h2 { text-align:center; }
table { width: 100%; border-collapse: collapse; margin-top:10px; }
th, td { border: 1px solid #999; padding: 6px; text-align: center; }
tr.dragging { opacity: 0.4; background: #ffffcc; }
button { margin: 2px; }
.badge { padding: 3px 6px; border-radius: 6px; }
.running { background-color: #d6f5d6; }
.paused { background-color: #fff0b3; }
.pending { background-color: #eee; }
.done { background-color: #ccc; text-decoration: line-through; }
</style>
</head>
<body>
<h2>🕒 מנהל משימות</h2>

<div>
  <strong id="overall"></strong>
</div>

<!-- הוספת משימה -->
<div>
  <input id="newName" placeholder="שם משימה">
  <input id="newH" type="number" min="0" placeholder="שעות" style="width:60px">
  <input id="newM" type="number" min="0" placeholder="דקות" style="width:60px">
  <input id="newS" type="number" min="0" placeholder="שניות" style="width:60px">
  <button onclick="addTask()">➕ הוסף משימה</button>
</div>

<table>
<thead>
<tr><th>שם</th><th>זמן כולל</th><th>נותר</th><th>סטטוס</th><th>פעולות</th><th>⬆⬇</th></tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<script>
async function api(url, method="GET", body=null) {
  const opt={method,headers:{'Content-Type':'application/json'}};
  if(body) opt.body=JSON.stringify(body);
  const r=await fetch(url,opt);
  return r.json();
}

async function render(){
  const data=await api("/state");
  document.getElementById("overall").innerText=
    `שעת סיום כוללת: ${data.overall_end_time} | עכשיו: ${data.now}`;
  const tb=document.getElementById("tbody");
  tb.innerHTML="";
  data.tasks.forEach((t,i)=>{
    const tr=document.createElement("tr");
    tr.dataset.id=t.id;
    tr.draggable=true;
    tr.className=t.status;
    tr.innerHTML=`
      <td>${t.name}</td>
      <td>${t.duration}s</td>
      <td>${t.remaining_hhmmss}</td>
      <td><span class="badge ${t.status}">${t.status}</span></td>
      <td>
        <button onclick="start(${t.id})">התחל</button>
        <button onclick="pause(${t.id})">השהה</button>
        <button onclick="del(${t.id})">מחק</button>
        <button onclick="extend(${t.id})">+10 דקות</button>
      </td>
      <td>
        <button onclick="move(${t.id},'up')">⬆</button>
        <button onclick="move(${t.id},'down')">⬇</button>
      </td>`;
    tb.appendChild(tr);
  });
  enableDrag();
}

async function addTask(){
  const name=document.getElementById("newName").value;
  const h=document.getElementById("newH").value;
  const m=document.getElementById("newM").value;
  const s=document.getElementById("newS").value;
  await api("/add","POST",{name,hours:h,minutes:m,seconds:s});
}

async function start(id){await api("/start/"+id,"POST");}
async function pause(id){await api("/pause/"+id,"POST");}
async function del(id){await api("/delete/"+id,"POST");}
async function extend(id){await api("/extend/"+id,"POST",{minutes:10});}

setInterval(render,1000);
render();

// --- גרירה ---
let dragSrc=null;
function enableDrag(){
  const rows=document.querySelectorAll("#tbody tr");
  rows.forEach(r=>{
    r.addEventListener("dragstart",e=>{
      dragSrc=r;
      r.classList.add("dragging");
      e.dataTransfer.effectAllowed="move";
    });
    r.addEventListener("dragover",e=>{
      e.preventDefault();
      const dragging=document.querySelector(".dragging");
      const target=e.target.closest("tr");
      if(target&&target!==dragging){
        const tbody=target.parentNode;
        const next=(e.clientY-target.getBoundingClientRect().top)>target.offsetHeight/2;
        tbody.insertBefore(dragging,next?target.nextSibling:target);
      }
    });
    r.addEventListener("drop",async()=>{
      r.classList.remove("dragging");
      await saveOrder();
    });
    r.addEventListener("dragend",()=>r.classList.remove("dragging"));
  });
}

async function saveOrder(){
  const ids=Array.from(document.querySelectorAll("#tbody tr")).map(tr=>parseInt(tr.dataset.id));
  await api("/reorder","POST",{order:ids});
}

// --- חיצים לשינוי ידני ---
async function move(id,dir){
  const rows=Array.from(document.querySelectorAll("#tbody tr"));
  const idx=rows.findIndex(r=>parseInt(r.dataset.id)===id);
  if(dir==="up" && idx>0){
    rows[idx].parentNode.insertBefore(rows[idx],rows[idx-1]);
  }else if(dir==="down" && idx<rows.length-1){
    rows[idx].parentNode.insertBefore(rows[idx+1],rows[idx]);
  }
  await saveOrder();
}
</script>
</body>
</html>
