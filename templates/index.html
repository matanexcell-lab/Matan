<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <title>⏱️ טיימר משימות</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; direction: rtl; background:#fafafa; }
    h1 { text-align:center; }
    table { width: 100%; border-collapse: collapse; margin-top:15px; background:white; }
    th, td { border: 1px solid #999; padding: 6px; text-align: center; }
    input[type="number"] { width: 64px; }
    input[type="text"] { width: 180px; }
    .muted { color: #777; font-size: 12px; }
    .badge { display:inline-block; padding:2px 6px; border-radius:6px; font-size:12px;}
    .running { background:#d9ffd9; }
    .paused  { background:#fff0b3; }
    .pending { background:#f2f2f2; }
    .done    { background:#e6e6e6; text-decoration: line-through; color:#666; }
    button { cursor:pointer; }
    .row-actions { display:flex; gap:4px; flex-wrap:wrap; justify-content:center; }
  </style>
</head>
<body>

<h1>⏱️ טיימר משימות</h1>

<div style="text-align:center">
  <div id="now" class="muted"></div>
  <b>שעת סיום כוללת:</b> <span id="overallEnd">-</span>
</div>

<div style="text-align:center;margin:10px 0">
  <input id="newName" type="text" placeholder="שם משימה">
  <input id="newH" type="number" min="0" value="0"> שעות
  <input id="newM" type="number" min="0" value="0"> דקות
  <input id="newS" type="number" min="0" value="0"> שניות
  <button id="btnAdd">➕ הוסף</button>
</div>

<table>
  <thead>
  <tr>
    <th>#</th>
    <th>שם</th>
    <th>נותר</th>
    <th>שעת סיום</th>
    <th>סטטוס</th>
    <th>פעולות</th>
  </tr>
  </thead>
  <tbody id="tbody"></tbody>
</table>

<script>
const $ = s => document.querySelector(s);
let tasks = [];
let fetching = false;
let lastUpdate = Date.now();

function fmt(t){t=Math.max(0,parseInt(t));let h=Math.floor(t/3600),m=Math.floor((t%3600)/60),s=t%60;return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;}
function badge(st){return st==='running'?'badge running':st==='paused'?'badge paused':st==='pending'?'badge pending':'badge done';}

async function api(url, method="GET", body=null, timeout=2000){
  const ctrl = new AbortController();
  const id = setTimeout(()=>ctrl.abort(), timeout);
  try {
    const res = await fetch(url, {method, headers:{'Content-Type':'application/json'}, body: body?JSON.stringify(body):null, signal:ctrl.signal});
    clearTimeout(id);
    return await res.json();
  } catch { return null; }
}

async function safeFetchState(){
  if(fetching) return;
  fetching = true;
  const data = await api("/state");
  fetching = false;
  if(!data || !data.ok) return;
  tasks = data.tasks;
  $("#overallEnd").textContent = data.overall_end_time;
  $("#now").textContent = data.now;
  renderTasks();
}

function renderTasks(){
  const tb=$("#tbody");
  tb.innerHTML="";
  tasks.forEach((t,i)=>{
    const tr=document.createElement("tr");
    tr.className=t.status;
    tr.innerHTML=`
      <td>${i+1}</td>
      <td>${t.name}</td>
      <td><span class="remain" data-id="${t.id}">${fmt(t.remaining)}</span></td>
      <td>${t.end_time_str||"-"}</td>
      <td><span class="${badge(t.status)}">${t.status}</span></td>
      <td class="row-actions">
        <button onclick="act('/start/${t.id}')">התחל</button>
        <button onclick="act('/pause/${t.id}')">השהה</button>
        <button onclick="act('/reset/${t.id}')">איפוס</button>
        <button onclick="act('/set_pending/${t.id}')">Pending</button>
        <button onclick="act('/skip/${t.id}')">דלג</button>
        <button onclick="act('/delete/${t.id}')">מחק</button>
      </td>`;
    tb.appendChild(tr);
  });
}

async function act(url){
  api(url,"POST"); // לא מחכה לתשובה
  safeFetchState(); // רענון רך
}

$("#btnAdd").onclick=async()=>{
  const n=$("#newName").value.trim()||"משימה חדשה";
  const h=parseInt($("#newH").value)||0,m=parseInt($("#newM").value)||0,s=parseInt($("#newS").value)||0;
  await api("/add","POST",{name:n,hours:h,minutes:m,seconds:s});
  $("#newName").value="";$("#newH").value=0;$("#newM").value=0;$("#newS").value=0;
  safeFetchState();
};

// עדכון שניות ברקע (מקומי)
setInterval(()=>{
  tasks.forEach(t=>{
    if(t.status==="running") t.remaining=Math.max(0,t.remaining-1);
  });
  $("#now").textContent=new Date().toLocaleTimeString("he-IL",{hour12:false});
  const rems=document.querySelectorAll(".remain");
  rems.forEach(span=>{
    const id=parseInt(span.dataset.id);
    const t=tasks.find(x=>x.id===id);
    if(t) span.textContent=fmt(t.remaining);
  });
},1000);

// פולינג מהשרת כל 3 שניות
setInterval(safeFetchState,3000);
safeFetchState();
</script>
</body>
</html>
