<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>טיימר משימות</title>
    <style>
        body { font-family: Arial, sans-serif; background:#f8f8f8; margin:20px; }
        h1 { text-align:center; }
        p { text-align:center; }
        table { width:100%; border-collapse:collapse; margin-top:20px; background:white; }
        th, td { border:1px solid #ccc; padding:8px; text-align:center; }
        th { background:#eee; }
        button { margin:2px; padding:5px 10px; }
        form.inline { display:inline; }
        .finished { background:#d3ffd3; }
        .running { background:#fff7cc; }
        .paused { background:#fdd; }
    </style>
</head>
<body>

<h1>⏱️ טיימר משימות</h1>

{% if total_end_time %}
<p><strong>🕒 כל המשימות צפויות להסתיים בשעה:</strong> {{ total_end_time }}</p>
{% endif %}

<!-- טופס הוספת משימה -->
<form action="{{ url_for('add_task') }}" method="post">
    <input type="text" name="name" placeholder="שם משימה" required>
    <label>שעות:</label>
    <input type="number" name="hours" min="0" value="0">
    <label>דקות:</label>
    <input type="number" name="minutes" min="0" value="0">
    <label>שניות:</label>
    <input type="number" name="seconds" min="0" value="0">
    <button type="submit">➕ הוסף משימה</button>
</form>

<!-- טבלת משימות -->
<table>
    <tr>
        <th>שם משימה</th>
        <th>סטטוס</th>
        <th>נותר</th>
        <th>שעת סיום</th>
        <th>פעולות</th>
    </tr>
    {% for task in tasks %}
    <tr class="{% if task.status=='רץ' %}running{% elif task.status=='הסתיים' %}finished{% elif task.status=='עצורה' %}paused{% endif %}">
        <td>
            <!-- עריכת משימה -->
            <form action="{{ url_for('edit_task', task_id=task.id) }}" method="post">
                <input type="text" name="name" value="{{ task.name }}">
                <input type="number" name="hours" min="0" value="{{ task.duration // 3600 }}">
                <input type="number" name="minutes" min="0" value="{{ (task.duration % 3600) // 60 }}">
                <input type="number" name="seconds" min="0" value="{{ task.duration % 60 }}">
                <button type="submit">💾</button>
            </form>
        </td>
        <td>{{ task.status }}</td>
        <td>
            <span class="countdown"
                  data-remaining="{{ task.remaining() }}">
                  {{ task.formatted_remaining() }}
            </span>
        </td>
        <td>
            {% if task.status == "רץ" and task.end_time %}
                {{ task.end_time.strftime("%H:%M:%S") }}
            {% elif task.status == "הסתיים" %}
                ✅ הסתיים
            {% else %}
                ⏳ ממתין
            {% endif %}
        </td>
        <td>
            <form action="{{ url_for('start_task', task_id=task.id) }}" method="get" class="inline">
                <button type="submit">▶️ התחל</button>
            </form>
            <form action="{{ url_for('pause_task', task_id=task.id) }}" method="get" class="inline">
                <button type="submit">⏸️ השהה</button>
            </form>
            <form action="{{ url_for('reset_task', task_id=task.id) }}" method="get" class="inline">
                <button type="submit">🔄 אפס</button>
            </form>
            <form action="{{ url_for('finish_task', task_id=task.id) }}" method="get" class="inline">
                <button type="submit">✅ סיים</button>
            </form>
            <form action="{{ url_for('delete_task', task_id=task.id) }}" method="get" class="inline">
                <button type="submit">🗑️ מחק</button>
            </form>
        </td>
    </tr>
    {% endfor %}
</table>

<!-- JS לספירה לאחור -->
<script>
function updateCountdowns() {
    document.querySelectorAll(".countdown").forEach(el => {
        let remaining = parseInt(el.dataset.remaining);
        if (isNaN(remaining)) return;

        if (remaining > 0) {
            remaining -= 1;
            el.dataset.remaining = remaining;

            let h = Math.floor(remaining / 3600);
            let m = Math.floor((remaining % 3600) / 60);
            let s = remaining % 60;
            el.textContent = 
                h.toString().padStart(2,"0")+":"+
                m.toString().padStart(2,"0")+":"+
                s.toString().padStart(2,"0");
        }
    });
}
setInterval(updateCountdowns, 1000);
</script>

</body>
</html>
