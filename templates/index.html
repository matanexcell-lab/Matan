<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <title>טיימר משימות</title>
  <style>
    body { font-family: Arial, sans-serif; direction: rtl; text-align: center; }
    table { width: 95%; margin: auto; border-collapse: collapse; }
    th, td { border: 1px solid #999; padding: 6px; text-align: center; }
    input[type="number"] { width: 60px; }
    input[type="text"] { width: 160px; }
    button { margin: 4px; padding: 6px 12px; }
  </style>
</head>
<body>

<h1>טיימר משימות</h1>

<div>
  <button id="reorderMode">סדר מחדש</button>
  <button id="saveReorder" style="display:none;">שמור סדר חדש</button>
  <button id="cancelReorder" style="display:none;">בטל</button>
</div>

<table>
  <thead>
  <tr><th>#</th><th>שם</th><th>זמן נותר</th><th>סטטוס</th><th>מיקום חדש</th><th>פעולות</th></tr>
  </thead>
  <tbody id="tbody"></tbody>
</table>

<script>
let reorderMode = false;

const $ = (s) => document.querySelector(s);
async function api(url, method="GET", body=null) {
  const opt = { method, headers: { "Content-Type": "application/json" } };
  if (body) opt.body = JSON.stringify(body);
  const res = await fetch(url, opt);
  if (!res.ok) throw new Error(res.statusText);
  return res.json();
}

async function render() {
  const data = await api("/state");
  const tb = $("#tbody");
  tb.innerHTML = "";
  data.tasks.forEach((t, i) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i + 1}</td>
      <td>${t.name}</td>
      <td>${t.remaining_hhmmss}</td>
      <td>${t.status}</td>
      <td>
        ${reorderMode ? `<input type="number" id="pos-${t.id}" min="1" max="${data.tasks.length}" value="${i + 1}">` : ""}
      </td>
      <td><button onclick="deleteTask(${t.id})">מחק</button></td>
    `;
    tb.appendChild(tr);
  });
}

async function deleteTask(id){
  await api(`/delete/${id}`, "POST");
  render();
}

$("#reorderMode").onclick = () => {
  reorderMode = true;
  $("#reorderMode").style.display = "none";
  $("#saveReorder").style.display = "inline-block";
  $("#cancelReorder").style.display = "inline-block";
  render();
};

$("#cancelReorder").onclick = () => {
  reorderMode = false;
  $("#reorderMode").style.display = "inline-block";
  $("#saveReorder").style.display = "none";
  $("#cancelReorder").style.display = "none";
  render();
};

$("#saveReorder").onclick = async () => {
  const inputs = document.querySelectorAll("[id^='pos-']");
  for (const input of inputs) {
    const id = parseInt(input.id.replace("pos-",""));
    const newPos = parseInt(input.value);
    await api("/reorder", "POST", { task_id: id, new_position: newPos });
  }
  reorderMode = false;
  $("#reorderMode").style.display = "inline-block";
  $("#saveReorder").style.display = "none";
  $("#cancelReorder").style.display = "none";
  render();
  alert("✅ הסדר נשמר בהצלחה!");
};

render();
setInterval(() => { if (!reorderMode) render(); }, 2000);
</script>
</body>
</html>
