<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>טיימר משימות</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background:#f9f9f9; }
        table { border-collapse: collapse; width: 100%; background: white; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
        th { background: #eee; }
        .running { background: #d1ffd1; }
        .paused { background: #fff3cd; }
        .done { background: #f0f0f0; text-decoration: line-through; }
        .error { color: red; font-weight: bold; }
    </style>
</head>
<body>
    <h1>⏱️ טיימר משימות</h1>

    {% if total_end_time %}
    <p><strong>🕒 כל המשימות צפויות להסתיים בשעה:</strong> {{ total_end_time }}</p>
    {% endif %}

    <h3>➕ הוסף משימה</h3>
    <div>
        <input type="text" id="newName" placeholder="שם משימה">
        <label>שעות</label><input type="number" id="newHours" value="0" min="0">
        <label>דקות</label><input type="number" id="newMinutes" value="0" min="0">
        <label>שניות</label><input type="number" id="newSeconds" value="0" min="0">
        <button onclick="addTask()">הוסף</button>
        <span id="addError" class="error"></span>
    </div>

    <h3>📋 רשימת משימות</h3>
    <table id="tasksTable">
        <thead>
            <tr>
                <th>שם</th>
                <th>סטטוס</th>
                <th>נותר</th>
                <th>שעת סיום</th>
                <th>פעולות</th>
            </tr>
        </thead>
        <tbody id="tasksBody"></tbody>
    </table>

<script>
let tasks = {};

function formatTime(sec){
    if(sec==null) return "";
    let h = Math.floor(sec/3600);
    let m = Math.floor((sec%3600)/60);
    let s = sec%60;
    return `${h.toString().padStart(2,"0")}:${m.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;
}

async function addTask(){
    const name = document.getElementById("newName").value;
    const hours = parseInt(document.getElementById("newHours").value)||0;
    const minutes = parseInt(document.getElementById("newMinutes").value)||0;
    const seconds = parseInt(document.getElementById("newSeconds").value)||0;
    const duration = hours*3600 + minutes*60 + seconds;
    if(duration<=0){
        document.getElementById("addError").innerText="⛔ יש להזין זמן גדול מ-0";
        return;
    }
    const res = await fetch("/tasks",{method:"POST",headers:{"Content-Type":"application/json"},
        body: JSON.stringify({name,hours,minutes,seconds})});
    if(res.ok) location.reload();
    else{
        const d = await res.json(); document.getElementById("addError").innerText=d.error||"שגיאה";
    }
}

async function startTask(id){ await fetch(`/start/${id}`,{method:"POST"}); }
async function pauseTask(id){ await fetch(`/pause/${id}`,{method:"POST"}); }
async function finishTask(id){ await fetch(`/finish/${id}`,{method:"POST"}); }
async function resetTask(id){ await fetch(`/reset/${id}`,{method:"POST"}); }
async function deleteTask(id){ await fetch(`/delete/${id}`,{method:"POST"}); }
async function editTask(id,newName,h,m,s){
    const body={}; if(newName!==null) body.name=newName;
    if(h||m||s){body.hours=h;body.minutes=m;body.seconds=s;}
    await fetch(`/edit/${id}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
}

function renderTasks(list){
    const tbody=document.getElementById("tasksBody"); tbody.innerHTML="";
    list.forEach(t=>{
        tasks[t.id]=t;
        const tr=document.createElement("tr"); tr.id="task-"+t.id; tr.className=t.status;
        tr.innerHTML=`
            <td contenteditable="true" onblur="editTask(${t.id}, this.innerText, null, null, null)">${t.name}</td>
            <td>${t.status}</td>
            <td id="remain-${t.id}">${formatTime(t.remaining_seconds)}</td>
            <td>${t.end_time||""}</td>
            <td>
                <button onclick="startTask(${t.id})">▶️ התחל</button>
                <button onclick="pauseTask(${t.id})">⏸️ השהה</button>
                <button onclick="finishTask(${t.id})">✅ סיים</button>
                <button onclick="resetTask(${t.id})">🌀 איפוס</button>
                <button onclick="deleteTask(${t.id})">🗑️ מחק</button><br>
                <label>שעות</label><input type="number" id="h-${t.id}" value="0" min="0">
                <label>דקות</label><input type="number" id="m-${t.id}" value="0" min="0">
                <label>שניות</label><input type="number" id="s-${t.id}" value="0" min="0">
                <button onclick="editTask(${t.id}, null,
                        document.getElementById('h-${t.id}').value,
                        document.getElementById('m-${t.id}').value,
                        document.getElementById('s-${t.id}').value)">✏️ עדכן זמן</button>
            </td>`;
        tbody.appendChild(tr);
    });
}

async function refreshState(){
    const res=await fetch("/state");
    if(res.ok){
        const list=await res.json(); renderTasks(list);
    }
}

setInterval(async ()=>{
    for(const id in tasks){
        const t=tasks[id];
        if(t.status==="running" && t.remaining_seconds>0){
            t.remaining_seconds-=1;
            document.getElementById("remain-"+id).innerText=formatTime(t.remaining_seconds);
        }
    }
},1000);

setInterval(refreshState,5000);
refreshState();
</script>
</body>
</html>
