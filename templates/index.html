<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8"/>
<title>×˜×™×™××¨ ××©×™××•×ª</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family: Arial, sans-serif; direction: rtl; background: #fafafa; }
h1 { text-align: center; }
table { width: 100%; border-collapse: collapse; background: white; margin-top: 15px; }
th, td { border: 1px solid #888; padding: 6px; text-align: center; }

input[type="number"] { width: 60px; }
input[type="text"] { width: 160px; }

.badge { padding: 3px 6px; border-radius: 4px; font-size: 12px; }
.running { background: #d9ffd9; }
.paused { background: #fff3cd; }
.pending { background: #f0f0f0; }
.done { background: #e3e3e3; text-decoration: line-through; }

.sim-row { background: #eef6ff; color: #003366; font-size: 12px; }
.hidden { display: none; }

.toolbar { text-align: center; margin-bottom: 10px; }
.tools { display: flex; justify-content: center; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
.row-actions { display: flex; justify-content: center; flex-wrap: wrap; gap: 6px; }
</style>
</head>

<body>

<h1>×˜×™×™××¨ ××©×™××•×ª</h1>

<div class="toolbar">
  <div id="now" style="color: #555; font-size: 12px;"></div>
  <b>×©×¢×ª ×¡×™×•× ×›×•×œ×œ×ª:</b> <span id="overallEnd">-</span><br>
  <b>×–××Ÿ ×¢×‘×•×“×” ×›×•×œ×œ:</b> <span id="workTotal">00:00:00</span><br><br>
  <button id="toggleSim">×”×¡×ª×¨ ×¡×™××•×œ×¦×™×”</button>
</div>

<div class="tools">
  <div>
    <input id="newName" type="text" placeholder="×©× ××©×™××”">
    <input id="newH" type="number" min="0" value="0">×©
    <input id="newM" type="number" min="0" value="0">×“
    <input id="newS" type="number" min="0" value="0">×©
    <input id="newPos" type="number" min="1" value="1" style="width:50px">××™×§×•×
    <button id="btnAdd">×”×•×¡×£</button>
  </div>

  <div>
    <button id="btnExport">×™×¦×</button>
    <label style="cursor:pointer">
      ×™×™×‘×
      <input id="fileImport" type="file" accept="application/json" style="display:none">
    </label>
  </div>
</div>

<table>
<thead>
<tr>
  <th>#</th>
  <th>×¢×‘×•×“×”</th>
  <th>×©×</th>
  <th>× ×•×ª×¨</th>
  <th>×”×ª×—×œ×”</th>
  <th>×¡×™×•×</th>
  <th>×¡×˜×˜×•×¡</th>
  <th>×¢×¨×™×›×”</th>
  <th>×”××¨×›×”</th>
  <th>×”×¢×‘×¨×”</th>
  <th>×¤×¢×•×œ×•×ª</th>
</tr>
</thead>

<tbody id="tbody"></tbody>
</table>

<script>
const $ = (s)=>document.querySelector(s);
let tasks = [];
let showSimulation = true;

function load() {
  const saved = localStorage.getItem("tasks");
  if (saved) tasks = JSON.parse(saved);
  render();
}

function save() {
  localStorage.setItem("tasks", JSON.stringify(tasks));
}

function fmt(sec){
  if (sec < 0) sec = 0;
  let h = Math.floor(sec/3600);
  let m = Math.floor((sec%3600)/60);
  let s = sec%60;
  return (h+"").padStart(2,"0")+":"+(m+"").padStart(2,"0")+":"+(s+"").padStart(2,"0");
}

function nowTime(){
  let d=new Date();
  return d.toLocaleTimeString("he-IL",{hour12:false});
}
setInterval(()=>{ $("#now").textContent=nowTime(); },1000);

function recalcOverallEnd(){
  let total=0;
  tasks.forEach(t => { if (t.status!=="done") total+=t.remaining; });
  $("#workTotal").textContent = fmt(total);

  let d=new Date();
  d.setSeconds(d.getSeconds()+total);
  $("#overallEnd").textContent = d.toLocaleTimeString("he-IL",{hour12:false});
}

function addTask(){
  let name=$("#newName").value.trim();
  let h=+$("#newH").value;
  let m=+$("#newM").value;
  let s=+$("#newS").value;
  let pos=+$("#newPos").value;

  if (!name) return;

  let total=h*3600+m*60+s;
  if (total<=0) total=60;

  let start="-";
  let end="-";

  let t={name,remaining:total,start,end,status:"pending"};
  tasks.splice(Math.max(0,pos-1),0,t);

  save();
  render();
}

$("#btnAdd").onclick = addTask;

function updateTask(i){
  let h=+document.querySelector(`#uh${i}`).value;
  let m=+document.querySelector(`#um${i}`).value;
  let s=+document.querySelector(`#us${i}`).value;

  let total=h*3600+m*60+s;
  if (total<=0) total=60;

  tasks[i].remaining=total;
  tasks[i].start="-";
  tasks[i].end="-";
  save();
  render();
}

function extendTask(i){
  let h=+document.querySelector(`#eh${i}`).value;
  let m=+document.querySelector(`#em${i}`).value;
  let s=+document.querySelector(`#es${i}`).value;
  let add=h*3600+m*60+s;
  if (add>0) tasks[i].remaining += add;
  save();
  render();
}

function moveTask(i){
  let to = prompt("×”×›× ×¡ ××™×§×•× ×—×“×©:", i+1);
  if (!to) return;
  to = +to-1;
  if (to<0) to=0;
  if (to>=tasks.length) to=tasks.length-1;
  let t=tasks.splice(i,1)[0];
  tasks.splice(to,0,t);
  save();
  render();
}

function del(i){
  tasks.splice(i,1);
  save();
  render();
}

function setStatus(i,status){
  let t = tasks[i];

  if (status === "running"){
    tasks.forEach(x => {
      if (x !== t && x.status === "running") x.status="paused";
    });
    t.start = nowTime();
  }

  if (status === "paused"){
    t.end = nowTime();
  }

  if (status === "done"){
    t.status="done";
    t.start="-";
    t.end="-";
    save();
    render();
    return;
  }

  t.status = status;
  save();
  render();
}

function resetTask(i){
  tasks[i].remaining = 0;
  tasks[i].start="-";
  tasks[i].end="-";
  save();
  render();
}
function simulateTask(t, startSim){
  let start = new Date(startSim.getTime());
  let end   = new Date(startSim.getTime() + t.remaining*1000);
  return {
    start: start.toLocaleTimeString("he-IL",{hour12:false}),
    end:   end.toLocaleTimeString("he-IL",{hour12:false})
  };
}

function render(){
  const tbody = $("#tbody");
  tbody.innerHTML = "";

  let startSimHour = +$("#simStart").value;
  let simStart = new Date();
  simStart.setHours(startSimHour,0,0,0);

  tasks.forEach((t,i)=>{
    let tr=document.createElement("tr");
    tr.innerHTML = `
      <td>${i+1}</td>
      <td><input value="${t.name}" onchange="tasks[${i}].name=this.value; save();"/></td>
      <td>${fmt(t.remaining)}</td>
      <td>${t.start||"-"}</td>
      <td>${t.end||"-"}</td>
      <td>${t.status}</td>
      <td>
        <input id="uh${i}" type="number" min="0" style="width:40px"> :
        <input id="um${i}" type="number" min="0" style="width:40px"> :
        <input id="us${i}" type="number" min="0" style="width:40px">
        <button onclick="updateTask(${i})">×¢×“×›×Ÿ</button>
      </td>
      <td>
        <input id="eh${i}" type="number" min="0" style="width:40px"> :
        <input id="em${i}" type="number" min="0" style="width:40px"> :
        <input id="es${i}" type="number" min="0" style="width:40px">
        <button onclick="extendTask(${i})">×”××¨×š</button>
      </td>
      <td>
        <button onclick="setStatus(${i},'running')">â–¶ï¸</button>
        <button onclick="setStatus(${i},'paused')">â¸ï¸</button>
        <button onclick="setStatus(${i},'done')">âœ”ï¸</button>
        <button onclick="resetTask(${i})">××™×¤×•×¡</button>
        <button onclick="moveTask(${i})">×”×¢×‘×¨</button>
        <button onclick="del(${i})">ğŸ—‘ï¸</button>
      </td>
    `;
    tbody.appendChild(tr);

    if (showSimulation){
      let sim = simulateTask(t, simStart);
      simStart = new Date(simStart.getTime() + t.remaining*1000);

      let simRow=document.createElement("tr");
      simRow.style.background="#f8f8f8";
      simRow.innerHTML = `
        <td colspan="9" style="text-align:center;color:#555;">
          ğŸŸ¦ ×¡×™××•×œ×¦×™×” â€” ×”×ª×—×œ×”: ${sim.start} | ×¡×™×•×: ${sim.end}
        </td>
      `;
      tbody.appendChild(simRow);
    }
  });

  recalcOverallEnd();
}

$("#toggleSim").onclick = ()=>{
  showSimulation = !showSimulation;
  $("#toggleSim").textContent = showSimulation ? "×”×¡×ª×¨ ×¡×™××•×œ×¦×™×”" : "×”×¦×’ ×¡×™××•×œ×¦×™×”";
  render();
};

load();

setInterval(()=>{
  let r = tasks.find(t=>t.status==="running");
  if (r){
    r.remaining--;
    if (r.remaining<=0){
      r.status="done";
      r.remaining=0;
      save();
      render();
      return;
    }
    save();
    render();
  }
},1000);