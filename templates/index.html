<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>מנהל משימות בזמן אמת</title>
    <style>
        body { font-family: "Assistant", sans-serif; text-align: center; direction: rtl; }
        .task { border: 1px solid #ccc; margin: 8px; padding: 8px; border-radius: 10px; cursor: grab; }
        .running { background: #d4f8d4; }
        .paused { background: #ffe9b3; }
        .pending { background: #eaeaea; }
        input, button { margin: 4px; }
        #tasks { max-width: 500px; margin: auto; }
    </style>
</head>
<body>
<h2>מנהל משימות בזמן אמת</h2>
<div>
    <input id="name" placeholder="שם המשימה">
    <input id="duration" type="number" placeholder="משך (בדקות)">
    <button onclick="addTask()">➕ הוסף משימה</button>
</div>
<div id="tasks"></div>

<script>
async function loadTasks() {
    const res = await fetch('/state');
    const tasks = await res.json();
    const container = document.getElementById('tasks');
    container.innerHTML = '';
    tasks.forEach(t => {
        const div = document.createElement('div');
        div.className = `task ${t.status}`;
        div.draggable = true;
        div.ondragstart = e => e.dataTransfer.setData("id", t.id);
        div.ondragover = e => e.preventDefault();
        div.ondrop = e => reorder(t.id, e.dataTransfer.getData("id"));
        div.innerHTML = `
            <b>${t.name}</b><br>
            זמן נותר: ${Math.max(0, t.remaining).toFixed(1)} דקות<br>
            סטטוס: ${t.status}<br>
            <button onclick="startTask(${t.id})">▶️ התחל</button>
            <button onclick="pauseTask(${t.id})">⏸️ השהה</button>
            <button onclick="deleteTask(${t.id})">🗑️ מחק</button>
        `;
        container.appendChild(div);
    });
}

async function addTask() {
    const name = document.getElementById('name').value.trim();
    const duration = parseInt(document.getElementById('duration').value);
    if (!name || !duration) return alert('הכנס שם וזמן');
    await fetch('/add', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({name, duration})
    });
    loadTasks();
}

async function startTask(id) {
    const res = await fetch('/update', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            id, status: 'running',
            start_time: new Date().toISOString(),
            end_time: new Date(Date.now() + 1000 * 60 * 60).toISOString()
        })
    });
    loadTasks();
}

async function pauseTask(id) {
    await fetch('/update', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({id, status: 'paused'})
    });
    loadTasks();
}

async function deleteTask(id) {
    await fetch(`/delete/${id}`, {method: 'DELETE'});
    loadTasks();
}

async function reorder(targetId, sourceId) {
    if (targetId === sourceId) return;
    const ids = [...document.querySelectorAll('.task')].map(el => parseInt(el.dataset.id));
    await fetch('/reorder', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({order: ids})
    });
    loadTasks();
}

setInterval(loadTasks, 5000);
loadTasks();
</script>
</body>
</html>
