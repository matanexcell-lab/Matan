<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>טיימר משימות</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;direction:rtl;text-align:center;margin:20px}
    table{border-collapse:collapse;width:95%;margin:auto}
    th,td{border:1px solid #333;padding:6px}
    th{background:#eee}
    button{margin:2px}
    .input-row{margin:12px}
    .input-row input{width:70px;text-align:center}
    .edit-time{width:48px;text-align:center}
    #overallEnd{margin:10px 0;font-weight:bold;font-size:18px}
    .muted{opacity:.6}
  </style>
</head>
<body>
  <h2>טיימר משימות</h2>

  <div class="input-row">
    <form id="addForm">
      שם משימה: <input type="text" name="name" value="משימה חדשה" />
      שעות: <input type="number" name="hours" min="0" value="0" />
      דקות: <input type="number" name="minutes" min="0" value="0" />
      שניות: <input type="number" name="seconds" min="0" value="0" />
      <button type="submit">➕ הוסף</button>
    </form>
  </div>

  <div id="overallEnd">שעת סיום כוללת: --:--:--</div>

  <table>
    <thead>
      <tr>
        <th>שם</th>
        <th>סטטוס</th>
        <th>זמן התחלתי</th>
        <th>שעת סיום</th>
        <th>נותר</th>
        <th>פעולות</th>
      </tr>
    </thead>
    <tbody id="taskBody"></tbody>
  </table>

  <script>
    const editing = new Set();
    function key(id, field){ return `row-${id}-${field}`; }

    function start(id){ $.post(`/start/${id}`, ()=>refresh()); }
    function pause(id){ $.post(`/pause/${id}`, ()=>refresh()); }
    function resetTask(id){ $.post(`/reset/${id}`, ()=>refresh()); }
    function delTask(id){ $.post(`/delete/${id}`, ()=>refresh()); }

    function saveName(id){
      const val = $(`#name-${id}`).val();
      $.post(`/edit/${id}`, {name: val}, ()=>refresh());
    }
    function saveTime(id){
      const h = $(`#h-${id}`).val() || 0;
      const m = $(`#m-${id}`).val() || 0;
      const s = $(`#s-${id}`).val() || 0;
      const nm = $(`#name-${id}`).val() || "";
      $.post(`/edit/${id}`, {name:nm,hours:h,minutes:m,seconds:s}, ()=>refresh());
    }

    function bindFreeze($el, id, field){
      const k=key(id,field);
      $el.on("focus", ()=>editing.add(k));
      $el.on("blur", ()=>editing.delete(k));
      $el.on("keydown",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); saveTime(id); $el.blur(); }});
    }

    function refresh(){
      $.getJSON("/state", function(resp){
        $("#overallEnd").text("שעת סיום כוללת: " + resp.overall_end);
        const $tb = $("#taskBody").empty();

        resp.tasks.forEach(t=>{
          const running = (t.status==="רץ");
          const row = $(`
            <tr>
              <td>${running
                ? `<span class="muted">${t.name}</span>`
                : `<input id="name-${t.id}" type="text" value="${t.name}" />`}
              </td>
              <td>${t.status}</td>
              <td>${t.initial}</td>
              <td>${t.end_time||""}</td>
              <td>${t.remaining}</td>
              <td>
                <button onclick="start(${t.id})">▶️</button>
                <button onclick="pause(${t.id})">⏸️</button>
                <button onclick="resetTask(${t.id})">🔄</button>
                <button onclick="delTask(${t.id})">🗑️</button>
                <div ${running?'class="muted"':""}>
                  שעות: <input id="h-${t.id}" class="edit-time" type="number" min="0">
                  דקות: <input id="m-${t.id}" class="edit-time" type="number" min="0">
                  שניות: <input id="s-${t.id}" class="edit-time" type="number" min="0">
                  <button onclick="saveTime(${t.id})" ${running?"disabled":""}>עדכן</button>
                </div>
              </td>
            </tr>
          `);
          $tb.append(row);

          if(!running){
            if(!editing.has(key(t.id,"h"))) $(`#h-${t.id}`).val(t.editable_hours);
            if(!editing.has(key(t.id,"m"))) $(`#m-${t.id}`).val(t.editable_minutes);
            if(!editing.has(key(t.id,"s"))) $(`#s-${t.id}`).val(t.editable_seconds);
            if(!editing.has(key(t.id,"name"))) $(`#name-${t.id}`).val(t.name);

            bindFreeze($(`#h-${t.id}`),t.id,"h");
            bindFreeze($(`#m-${t.id}`),t.id,"m");
            bindFreeze($(`#s-${t.id}`),t.id,"s");
            bindFreeze($(`#name-${t.id}`),t.id,"name");

            $(`#name-${t.id}`).off("change").on("change",()=>saveName(t.id));
          }
        });
      });
    }

    $("#addForm").on("submit",function(e){
      e.preventDefault();
      $.post("/add",$(this).serialize(),()=>refresh());
    });

    setInterval(refresh,1000);
    refresh();
  </script>
</body>
</html>
