<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8">
<title>×× ×”×œ ××©×™××•×ª</title>
<style>
body { font-family: Arial, sans-serif; direction: rtl; padding: 10px; }
h2 { text-align: center; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { border: 1px solid #999; padding: 6px; text-align: center; }
tr.dragging { opacity: 0.4; background: #ffffcc; }
button { margin: 2px; }
.running { background-color: #d6f5d6; }
.paused { background-color: #fff0b3; }
.pending { background-color: #eee; }
.done { background-color: #ccc; text-decoration: line-through; }
</style>
</head>
<body>
<h2>ğŸ“‹ ×× ×”×œ ××©×™××•×ª</h2>

<div id="overall"></div>

<div>
  <input id="newName" placeholder="×©× ××©×™××”">
  <input id="newH" type="number" min="0" placeholder="×©×¢×•×ª" style="width:60px">
  <input id="newM" type="number" min="0" placeholder="×“×§×•×ª" style="width:60px">
  <input id="newS" type="number" min="0" placeholder="×©× ×™×•×ª" style="width:60px">
  <button onclick="addTask()">â• ×”×•×¡×£ ××©×™××”</button>
</div>

<table>
<thead>
<tr><th>×©×</th><th>××©×š</th><th>× ×•×ª×¨</th><th>×©×¢×ª ×¡×™×•×</th><th>×¡×˜×˜×•×¡</th><th>×¤×¢×•×œ×•×ª</th></tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<script>
async function api(url, method="GET", body=null){
  const opt={method,headers:{'Content-Type':'application/json'}};
  if(body) opt.body=JSON.stringify(body);
  const res=await fetch(url,opt);
  return res.json();
}

async function render(){
  const data=await api("/state");
  document.getElementById("overall").innerText=
    `×©×¢×ª ×¡×™×•× ×›×•×œ×œ×ª: ${data.overall_end_time} | ×¢×›×©×™×•: ${data.now}`;
  const tb=document.getElementById("tbody");
  tb.innerHTML="";
  data.tasks.forEach(t=>{
    const tr=document.createElement("tr");
    tr.draggable=true;
    tr.dataset.id=t.id;
    tr.className=t.status;
    tr.innerHTML=`
      <td contenteditable="true" onblur="updateName(${t.id}, this.innerText)">${t.name}</td>
      <td>${t.duration}s</td>
      <td>${t.remaining_hhmmss}</td>
      <td>${t.end_time_str}</td>
      <td>${t.status}</td>
      <td>
        <button onclick="start(${t.id})">â–¶ï¸</button>
        <button onclick="pause(${t.id})">â¸ï¸</button>
        <button onclick="extend(${t.id})">+5 ×“×§'</button>
        <button onclick="del(${t.id})">ğŸ—‘ï¸</button>
      </td>`;
    tb.appendChild(tr);
  });
  enableDrag();
}

async function addTask(){
  const name=document.getElementById("newName").value;
  const h=document.getElementById("newH").value||0;
  const m=document.getElementById("newM").value||0;
  const s=document.getElementById("newS").value||0;
  await api("/add","POST",{name,hours:h,minutes:m,seconds:s});
  document.getElementById("newName").value="";
  document.getElementById("newH").value="";
  document.getElementById("newM").value="";
  document.getElementById("newS").value="";
  render();
}

async function start(id){await api("/start/"+id,"POST");}
async function pause(id){await api("/pause/"+id,"POST");}
async function del(id){await api("/delete/"+id,"POST"); render();}
async function extend(id){await api("/extend/"+id,"POST",{minutes:5});}

async function updateName(id,newName){await api("/update/"+id,"POST",{name:newName});}

setInterval(render,1000);
render();

// --- ×’×¨×™×¨×” ×œ×¡×™×“×•×¨ ××©×™××•×ª ---
let dragSrc=null;
function enableDrag(){
  const rows=document.querySelectorAll("#tbody tr");
  rows.forEach(r=>{
    r.addEventListener("dragstart",e=>{
      dragSrc=r; r.classList.add("dragging"); e.dataTransfer.effectAllowed="move";
    });
    r.addEventListener("dragover",e=>{
      e.preventDefault();
      const dragging=document.querySelector(".dragging");
      const target=e.target.closest("tr");
      if(target && target!==dragging){
        const tbody=target.parentNode;
        const next=(e.clientY-target.getBoundingClientRect().top)>target.offsetHeight/2;
        tbody.insertBefore(dragging,next?target.nextSibling:target);
      }
    });
    r.addEventListener("drop",async()=>{r.classList.remove("dragging"); await saveOrder();});
    r.addEventListener("dragend",()=>r.classList.remove("dragging"));
  });
}

async function saveOrder(){
  const ids=Array.from(document.querySelectorAll("#tbody tr")).map(tr=>parseInt(tr.dataset.id));
  await api("/reorder","POST",{order:ids});
}
</script>
</body>
</html>
