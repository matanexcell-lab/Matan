<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8"/>
<title>â±ï¸ ×˜×™×™××¨ ××©×™××•×ª</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body { font-family: Arial, sans-serif; direction: rtl; background:#fafafa; }
  h1 { text-align:center; }
  table { width: 100%; border-collapse: collapse; margin-top:15px; background:white; }
  th, td { border: 1px solid #999; padding: 6px; text-align: center; }
  input[type="number"] { width: 60px; }
  input[type="text"] { width: 160px; }
  .badge { padding:2px 6px; border-radius:6px; font-size:12px; display:inline-block; }
  .running { background:#d9ffd9; }
  .paused { background:#fff0b3; }
  .pending { background:#f2f2f2; }
  .done { background:#ddd; text-decoration:line-through; color:#666; }
</style>
</head>
<body>
<h1>â±ï¸ ×˜×™×™××¨ ××©×™××•×ª</h1>

<div style="text-align:center;margin-bottom:10px">
  <div id="now"></div>
  <b>×©×¢×ª ×¡×™×•× ×›×•×œ×œ×ª:</b> <span id="overallEnd">-</span><br>
  <b>×¡×”×´×› ×–××Ÿ ×¢×‘×•×“×”:</b> <span id="workTime">00:00:00</span>
</div>

<!-- ×”×•×¡×¤×ª ××©×™××” -->
<div style="text-align:center;margin-bottom:10px">
  <input id="newName" type="text" placeholder="×©× ××©×™××”">
  <input id="newH" type="number" min="0" value="0"> ×©×¢×•×ª
  <input id="newM" type="number" min="0" value="0"> ×“×§×•×ª
  <input id="newS" type="number" min="0" value="0"> ×©× ×™×•×ª
  <button id="btnAdd">â• ×”×•×¡×£</button>
  <button id="btnExport">ğŸ“¤ ×™×™×¦×•×</button>
  <input id="importFile" type="file" accept=".json" style="display:none">
  <button id="btnImport">ğŸ“¥ ×™×™×‘×•×</button>
</div>

<table>
<thead>
<tr>
  <th>#</th><th>×©×</th><th>× ×•×ª×¨</th><th>×¡×˜×˜×•×¡</th><th>×¢×‘×•×“×”</th><th>×¤×¢×•×œ×•×ª</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<script>
const $=s=>document.querySelector(s);
let tasks=[];
async function api(u,m="GET",b=null){
  const r=await fetch(u,{method:m,headers:{'Content-Type':'application/json'},body:b?JSON.stringify(b):null});
  return await r.json();
}
function fmt(t){t=Math.max(0,parseInt(t));let h=Math.floor(t/3600),m=Math.floor((t%3600)/60),s=t%60;return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;}
function badge(st){return `<span class="badge ${st}">${st}</span>`;}
async function sync(){
  const d=await api("/state");
  if(!d.ok)return;
  tasks=d.tasks;
  $("#overallEnd").textContent=d.overall_end_time;
  $("#workTime").textContent=d.total_work_time;
  render();
}
function render(){
  const tb=$("#tbody");tb.innerHTML="";
  tasks.forEach((t,i)=>{
    const tr=document.createElement("tr");
    tr.className=t.status;
    tr.innerHTML=`
      <td>${i+1}</td>
      <td>${t.name}</td>
      <td>${fmt(t.remaining)}</td>
      <td>${badge(t.status)}</td>
      <td><input type="checkbox" ${t.is_work?"checked":""} onchange="toggleWork(${t.id})"></td>
      <td>
        <button onclick="action('/start/${t.id}')">×”×ª×—×œ</button>
        <button onclick="action('/pause/${t.id}')">×”×©×”×”</button>
        <button onclick="action('/delete/${t.id}')">××—×§</button>
      </td>`;
    tb.appendChild(tr);
  });
}
async function toggleWork(id){
  await api(`/set_work/${id}`,"POST");
  await sync();
}
async function action(u){await api(u,"POST");await sync();}
$("#btnAdd").onclick=async()=>{
  const n=$("#newName").value.trim()||"××©×™××” ×—×“×©×”";
  const h=parseInt($("#newH").value)||0,m=parseInt($("#newM").value)||0,s=parseInt($("#newS").value)||0;
  await api("/add","POST",{name:n,hours:h,minutes:m,seconds:s});
  $("#newName").value="";$("#newH").value=0;$("#newM").value=0;$("#newS").value=0;
  await sync();
};

// ğŸ“¤ ×™×™×¦×•× ×œ×§×•×‘×¥ JSON
$("#btnExport").onclick=async()=>{
  const data=await api("/export");
  const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download="tasks_backup.json";
  a.click();
  URL.revokeObjectURL(url);
};

// ğŸ“¥ ×™×™×‘×•× ×§×•×‘×¥ JSON
$("#btnImport").onclick=()=>$("#importFile").click();
$("#importFile").onchange=async(e)=>{
  const file=e.target.files[0];
  if(!file)return;
  const text=await file.text();
  const json=JSON.parse(text);
  await api("/import","POST",json);
  await sync();
};

setInterval(()=>{$("#now").textContent=new Date().toLocaleTimeString("he-IL",{hour12:false});},1000);
setInterval(sync,2500);
sync();
</script>
</body>
</html>