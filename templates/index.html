<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>טיימר משימות</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background:#f9f9f9; }
        h1 { margin-bottom: 10px; }
        table { border-collapse: collapse; width: 100%; background: white; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
        th { background: #eee; }
        button { margin: 2px; padding: 5px 10px; }
        input[type=number] { width: 60px; }
        input[type=text] { width: 150px; }
        .running { background: #d1ffd1; }
        .paused { background: #fff3cd; }
        .done { background: #f0f0f0; text-decoration: line-through; }
        .error { color: red; font-weight: bold; }
    </style>
</head>
<body>
    <h1>⏱️ טיימר משימות</h1>

    {% if total_end_time %}
    <p><strong>🕒 כל המשימות צפויות להסתיים בשעה:</strong> {{ total_end_time }}</p>
    {% endif %}

    <h3>➕ הוסף משימה</h3>
    <div>
        <input type="text" id="newName" placeholder="שם משימה">
        <label>שעות</label><input type="number" id="newHours" value="0" min="0">
        <label>דקות</label><input type="number" id="newMinutes" value="0" min="0">
        <label>שניות</label><input type="number" id="newSeconds" value="0" min="0">
        <button onclick="addTask()">הוסף</button>
        <span id="addError" class="error"></span>
    </div>

    <h3>📋 רשימת משימות</h3>
    <table id="tasksTable">
        <thead>
            <tr>
                <th>שם</th>
                <th>סטטוס</th>
                <th>נותר</th>
                <th>שעת סיום</th>
                <th>פעולות</th>
            </tr>
        </thead>
        <tbody id="tasksBody">
            {% for t in tasks %}
            <tr id="task-{{t.id}}" class="{{t.status}}">
                <td contenteditable="true" onblur="editTask({{t.id}}, this.innerText, null, null, null)">{{t.name}}</td>
                <td>{{t.status}}</td>
                <td>{{t.remaining_seconds}}</td>
                <td>{{t.end_time or ''}}</td>
                <td>
                    <button onclick="startTask({{t.id}})">▶️ התחל</button>
                    <button onclick="pauseTask({{t.id}})">⏸️ השהה</button>
                    <button onclick="finishTask({{t.id}})">✅ סיים</button>
                    <button onclick="deleteTask({{t.id}})">🗑️ מחק</button><br>
                    <label>שעות</label><input type="number" id="h-{{t.id}}" value="0" min="0">
                    <label>דקות</label><input type="number" id="m-{{t.id}}" value="0" min="0">
                    <label>שניות</label><input type="number" id="s-{{t.id}}" value="0" min="0">
                    <button onclick="editTask({{t.id}}, null,
                            document.getElementById('h-{{t.id}}').value,
                            document.getElementById('m-{{t.id}}').value,
                            document.getElementById('s-{{t.id}}').value)">✏️ עדכן זמן</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

<script>
async function addTask() {
    const name = document.getElementById("newName").value;
    const hours = parseInt(document.getElementById("newHours").value) || 0;
    const minutes = parseInt(document.getElementById("newMinutes").value) || 0;
    const seconds = parseInt(document.getElementById("newSeconds").value) || 0;
    const duration = hours*3600 + minutes*60 + seconds;
    if(duration <= 0){
        document.getElementById("addError").innerText = "⛔ יש להזין זמן גדול מ-0";
        return;
    }
    const res = await fetch("/tasks", {
        method:"POST", headers:{"Content-Type":"application/json"},
        body: JSON.stringify({name, hours, minutes, seconds})
    });
    if(res.ok){ location.reload(); }
    else{
        const data = await res.json();
        document.getElementById("addError").innerText = data.error || "שגיאה";
    }
}

async function startTask(id){
    await fetch(`/start/${id}`, {method:"POST"});
    location.reload();
}
async function pauseTask(id){
    await fetch(`/pause/${id}`, {method:"POST"});
    location.reload();
}
async function finishTask(id){
    await fetch(`/finish/${id}`, {method:"POST"});
    location.reload();
}
async function deleteTask(id){
    await fetch(`/delete/${id}`, {method:"POST"});
    location.reload();
}
async function editTask(id, newName, h,m,s){
    const body = {};
    if(newName!==null) body.name=newName;
    if(h!==null || m!==null || s!==null){
        body.hours=h; body.minutes=m; body.seconds=s;
    }
    await fetch(`/edit/${id}`, {
        method:"POST", headers:{"Content-Type":"application/json"},
        body: JSON.stringify(body)
    });
    location.reload();
}

async function refreshState(){
    const res = await fetch("/state");
    if(res.ok){
        const tasks = await res.json();
        tasks.forEach(t=>{
            const row = document.getElementById("task-"+t.id);
            if(row){
                row.className = t.status;
                row.cells[1].innerText = t.status;
                row.cells[2].innerText = t.remaining_seconds;
                row.cells[3].innerText = t.end_time || "";
            }
        });
    }
}
setInterval(refreshState, 1000);
</script>
</body>
</html>
