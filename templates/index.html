<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <title>â±ï¸ ×˜×™×™××¨ ××©×™××•×ª</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; direction: rtl; background:#fafafa; }
    h1 { text-align:center; margin-bottom:5px; }
    table { width: 100%; border-collapse: collapse; margin-top:15px; background:white; }
    th, td { border: 1px solid #999; padding: 5px; text-align: center; }
    .row-sim { background:#f3f3f3; font-size:13px; color:#555; }
    .sim-label { font-weight:bold; }
    input[type="number"] { width: 64px; }
    input[type="text"] { width: 180px; }
    .muted { color: #777; font-size: 12px; }
    .badge { display:inline-block; padding:2px 6px; border-radius:6px; font-size:12px;}
    .running { background:#d9ffd9; transition: background-color 0.4s ease; }
    .paused  { background:#fff0b3; transition: background-color 0.4s ease; }
    .pending { background:#f2f2f2; transition: background-color 0.4s ease; }
    .done    { background:#e6e6e6; color:#666; text-decoration: line-through; transition: background-color 0.4s ease; }
    button { cursor:pointer; }
    .row-actions { display:flex; gap:4px; flex-wrap:wrap; justify-content:center; }
  </style>
</head>
<body>

<h1>â±ï¸ ×˜×™×™××¨ ××©×™××•×ª</h1>

<div id="now" class="muted" style="text-align:center"></div>
<div style="text-align:center">
  <b>×©×¢×ª ×¡×™×•× ×›×•×œ×œ×ª:</b> <span id="overallEnd">-</span><br>
  <b>×–××Ÿ ×¢×‘×•×“×” ×›×•×œ×œ:</b> <span id="workTotal">00:00:00</span>
</div>

<div style="text-align:center;margin-top:10px;">
  <input id="newName" type="text" placeholder="×©× ××©×™××”">
  <input id="newH" type="number" value="0"> ×©×¢×•×ª
  <input id="newM" type="number" value="0"> ×“×§×•×ª
  <input id="newS" type="number" value="0"> ×©× ×™×•×ª
  <input id="newPos" type="number" value="1"> ××™×§×•×
  <button id="btnAdd">â• ×”×•×¡×£</button>
</div>

<div style="text-align:center; margin-top:10px;">
  <button id="btnExport">ğŸ“¤ ×™×™×¦×</button>
  <label style="cursor:pointer">
    ğŸ“¥ ×™×™×‘×
    <input id="fileImport" type="file" accept="application/json" style="display:none">
  </label>

  <button id="btnToggleSim">×”×¡×ª×¨ ×¡×™××•×œ×¦×™×”</button>
</div>

<table>
  <thead>
    <tr>
      <th>#</th>
      <th>×¢×‘×•×“×”</th>
      <th>×©×</th>
      <th>× ×•×ª×¨</th>
      <th>×©×¢×ª ×”×ª×—×œ×”</th>
      <th>×©×¢×ª ×¡×™×•×</th>
      <th>×¡×˜×˜×•×¡</th>
      <th>×¢×¨×™×›×”</th>
      <th>×”××¨×›×”</th>
      <th>×”×¢×‘×¨×”</th>
      <th>×¤×¢×•×œ×•×ª</th>
    </tr>
  </thead>
  <tbody id="tbody"></tbody>
</table>

<script>
const $ = s => document.querySelector(s);
let tasks = [];
let showSim = true;
const tzFmt = new Intl.DateTimeFormat('he-IL', {hour12:false, hour:'2-digit', minute:'2-digit', second:'2-digit'});

function fmt(t){
  t=Math.max(0,parseInt(t)||0);
  return new Date(t*1000).toISOString().substring(11,19);
}

async function api(url, method="GET", body=null){
  let res = await fetch(url,{method,headers:{'Content-Type':'application/json'},body:body?JSON.stringify(body):null});
  return await res.json();
}

$("#btnToggleSim").onclick=function(){
  showSim=!showSim;
  this.textContent=showSim?"×”×¡×ª×¨ ×¡×™××•×œ×¦×™×”":"×”×¦×’ ×¡×™××•×œ×¦×™×”";
  renderTasks();
};

function computeSimLayout(){
  let now=Date.now();
  let layout=[];
  let base=now;
  for(const t of tasks){
    let dur = Math.max(0,t.remaining)*1000;
    layout.push({
      id:t.id,
      start:base,
      end:base+dur,
      remaining:t.remaining
    });
    base+=dur;
  }
  return layout;
}

function renderTasks(){
  const tb=$("#tbody");
  tb.innerHTML="";

  let sim = computeSimLayout();

  tasks.forEach((t,i)=>{
    let row=document.createElement("tr");
    row.className=t.status;
    row.innerHTML=`
      <td>${i+1}</td>
      <td><input type="checkbox" class="flag" ${t.is_work?"checked":""}></td>
      <td><input class="nm" value="${t.name}"></td>
      <td>${fmt(t.remaining)}</td>
      <td>${t.start_str||"-"}</td>
      <td>${t.end_str||"-"}</td>
      <td>${t.status}</td>
      <td>
        <input class="ed-h" type="number" value="0"> :
        <input class="ed-m" type="number" value="0"> :
        <input class="ed-s" type="number" value="0">
        <button class="btn-upd">×¢×“×›×Ÿ</button>
      </td>
      <td>
        <input class="ex-h" type="number" value="0"> :
        <input class="ex-m" type="number" value="0"> :
        <input class="ex-s" type="number" value="0">
        <button class="btn-ext">×”××¨×š</button>
      </td>
      <td>
        <input class="mv" type="number" value="${i+1}">
        <button class="btn-mv">×”×¢×‘×¨</button>
      </td>
      <td>
        <button class="btn-start">â–¶ï¸</button>
        <button class="btn-pause">â¸ï¸</button>
        <button class="btn-reset">ğŸ”„</button>
        <button class="btn-pending">ğŸ•‘</button>
        <button class="btn-del">ğŸ—‘ï¸</button>
      </td>
    `;
    tb.appendChild(row);

    let simRow=document.createElement("tr");
    simRow.className="row-sim";
    let s=sim.find(x=>x.id===t.id);
    simRow.innerHTML=`
      <td colspan="11">
        <span class="sim-label">×¡×™××•×œ×¦×™×”:</span>
        ×”×ª×—×œ×”: ${tzFmt.format(new Date(s.start))},
        ×¡×™×•×: ${tzFmt.format(new Date(s.end))},
        × ×•×ª×¨: ${fmt(s.remaining)}
      </td>
    `;
    if(showSim) tb.appendChild(simRow);

    row.querySelector(".flag").onchange=async(e)=>{await api(`/flag/${t.id}`,"POST",{v:e.target.checked});load();};
    row.querySelector(".btn-start").onclick=()=>{api(`/start/${t.id}`,"POST").then(load);};
    row.querySelector(".btn-pause").onclick=()=>{api(`/pause/${t.id}`,"POST").then(load);};
    row.querySelector(".btn-reset").onclick=()=>{api(`/reset/${t.id}`,"POST").then(load);};
    row.querySelector(".btn-pending").onclick=()=>{api(`/pending/${t.id}`,"POST").then(load);};
    row.querySelector(".btn-del").onclick=()=>{api(`/delete/${t.id}`,"POST").then(load);};

    row.querySelector(".btn-upd").onclick=()=>{
      let h=row.querySelector(".ed-h").value;
      let m=row.querySelector(".ed-m").value;
      let s=row.querySelector(".ed-s").value;
      let nm=row.querySelector(".nm").value;
      api(`/update/${t.id}`,"POST",{name:nm,hours:h,minutes:m,seconds:s}).then(load);
    };

    row.querySelector(".btn-ext").onclick=()=>{
      let h=row.querySelector(".ex-h").value;
      let m=row.querySelector(".ex-m").value;
      let s=row.querySelector(".ex-s").value;
      api(`/extend/${t.id}`,"POST",{hours:h,minutes:m,seconds:s}).then(load);
    };

    row.querySelector(".btn-mv").onclick=()=>{
      let pos=parseInt(row.querySelector(".mv").value);
      api(`/move/${t.id}`,"POST",{pos:pos}).then(load);
    };
  });
}

async function load(){
  let r=await api("/state");
  tasks=r.tasks;
  $("#now").textContent=r.now;
  $("#overallEnd").textContent=r.overall_end;
  $("#workTotal").textContent=r.work_total;
  renderTasks();
}

$("#btnAdd").onclick=()=>{
  let nm=$("#newName").value;
  let h=$("#newH").value;
  let m=$("#newM").value;
  let s=$("#newS").value;
  let p=$("#newPos").value;
  api("/add","POST",{name:nm,hours:h,minutes:m,seconds:s,pos:p}).then(load);
};

$("#btnExport").onclick=async()=>{
  let r=await fetch("/export");
  let b=await r.blob();
  let u=URL.createObjectURL(b);
  let a=document.createElement("a");
  a.href=u; a.download="tasks.json"; a.click();
  URL.revokeObjectURL(u);
};

$("#fileImport").onchange=async(e)=>{
  let f=e.target.files[0];
  let t=await f.text();
  let j=JSON.parse(t);
  await api("/import","POST",j);
  load();
};

setInterval(load,2500);
load();
</script>
</body>
</html>